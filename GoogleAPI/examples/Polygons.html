<!DOCTYPE html>
<html>
<head>
    <title>Drawing tools</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100%;
        }
    </style>

    <script type="text/javascript">
        //        var esito = [];
        //        function check() {
        //            var server = '../database.php';
        //            richiesta = new XMLHttpRequest();
        //            richiesta.onreadystatechange = asynchronousUpdate;
        //            richiesta.open("POST", server, true);
        //            richiesta.send(null);
        //        }
        //        function asynchronousUpdate() {
        //            if ((richiesta.readyState == 4) &&
        //                    (richiesta.status == 200)) {
        //                housesList = richiesta.responseText;
        ////                esito = JSON.parse(housesList);
        ////                document.getElementById("result").innerHTML = esito;
        //            }
        //        }
    </script>

</head>
<body>
<input type="button" id="check" name="check" value="check">
<!--<input type="submit" onclick="check()" value="check">-->
<div id="result"></div>
<div id="description">description</div>

<div id="array" onclick="remove();">remove</div>
<div id="array2" onclick="initMap();">initMap</div>
<div id="map" style="max-width:700px;max-height:400px;"></div>

<script src="https://code.jquery.com/jquery-3.1.1.js" integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA="
        crossorigin="anonymous"></script>
<!--<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLny4Q7L4wBTjw4FQcygnpnM7-1TLbYyM&libraries=drawing"></script>-->
<script>

    var markers = [];
    var shapes = [];
    var personalVertices = [];

    function initMap() {


        var map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 53.482478, lng: -2.232023},
            zoom: 16
        });

        var sColor = '#6080a0';
        var fColor = '#6080a0';
        var fOpacity = 0;
        var sWeight = 2;
        var drawingManager = new google.maps.drawing.DrawingManager({
            drawingMode: google.maps.drawing.OverlayType.FALSE,
            drawingControl: true,
            drawingControlOptions: {
                position: google.maps.ControlPosition.TOP_CENTER,
                drawingModes: ['polygon']
            },
            circleOptions: {
                fillColor: fColor,
                fillOpacity: fOpacity,
                strokeWeight: sWeight,
                strokeColor: sColor,
                clickable: false,
                editable: false,
                zIndex: 1
            },
            polygonOptions: {
                strokeColor: sColor,
                fillColor: fColor,
                fillOpacity: fOpacity,
                strokeWeight: sWeight,
                clickable: false,
                editable: false,
                zIndex: 0,
            },

        });

        drawingManager.setMap(map);

// launch this function when a shape is drawn
        google.maps.event.addListener(drawingManager, 'overlaycomplete', function (event) {
            google.maps.event.clearListeners(map, 'click');

            remove();

            if (event.type == 'polygon') {
//              Remove all the previous markers and shapes
//              Add the shape to the array
                shapes.push(event.overlay);

                var vertices = event.overlay.getPath();
                for (var i = 0; i < vertices.getLength(); i++) {
                    var xy = vertices.getAt(i);
                    personalVertices[i] = {'lat': xy.lat(), 'lng': xy.lng()};
                }


//                CALL THE FUNCTION TO CHECK IF DOTS ARE INSIDE THE VERTICES
                var personalShape = new google.maps.Polygon({paths: personalVertices});
                dots(personalShape);
            }
        });

//        draw the marker over the house


        function dots(shape) {

            for (var i = 0; i < properties.length; i++) {
//                console.log(properties[i].split(','));
//                console.log(properties[i].split(',')[0]);
//                console.log(properties[i].split(',')[1]);
//                var newLatLng = properties[i];
//                var myLatLng = {lat: 53.483072, lng: -2.233058};
                
                var newLatLng = new google.maps.LatLng(properties[i].split(',')[0], properties[i].split(',')[1]);
//                var newLatLng = new google.maps.LatLng(myLatLng.lat, myLatLng.lng);
                var resultOpacity =
                        google.maps.geometry.poly.containsLocation(newLatLng, shape) ?
                                1 :
                                0.2;

//                Draws the dots over the houses
                var house = new google.maps.Marker({
                    position: newLatLng,
                    map: map,
                    title: 'Hello World!',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillOpacity: resultOpacity,
                        strokeColor: 'white',
                        strokeWeight: .5,
                        scale: 10,
                        zIndex: 1,
                    }
                });
                markers.push(house);
            }

//            });
        }
    }

    var remove = function () {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }

        for (var i = 0; i < shapes.length; i++) {
            shapes[i].setMap(null);
        }
        markers.length = 0;
        shapes.length = 0;
    }

    //jquery db function
    $(document).ready(function () {
        properties = new Array();

        $("#check").click(function () {
            $.ajax({
                url: "../database.php",
                type: "POST",
                success: function (msg) {
                    properties = msg;
                },
                dataType: "json"
            });

        });
    });
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDeigJ0MtRTk-X-plGt4BDf_1QiSCMh91Q&libraries=drawing&callback=initMap"
        async defer></script>
</body>
</html>